<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>MindCare</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <link href="{{ url_for('static', filename='styles/style.css') }}" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
<section class="msger">
    <header class="msger-header">
        <div class="msger-header-title">
            <i class="fas fa-bug"></i> MindCare Chatbot <i class="fas fa-bug"></i>
        </div>
    </header>

    <main class="msger-chat">
        {% for message in messages %}
        {% if message.side == "left" %}
        <div class="msg left-msg">
            {% else %}
            <div class="msg right-msg">
                {% endif %}
                <div class="msg-img" style="background-image: url({{ message.img }})"></div>
                <div class="msg-bubble">
                    <div class="msg-info">
                        <div class="msg-info-name">{{ message.name }}</div>
                        <div class="msg-info-time">{{ message.time }}</div>
                    </div>
                    <div class="msg-text">{{ message.text }}</div>
                </div>
            </div>
            {% endfor %}
    </main>

    <form action="/chat" class="msger-inputarea" method="POST">
        <input class="msger-input" id="textInput" name="message" placeholder="Enter your message..." type="text">
        <button class="msger-send-btn" type="submit">Send</button>
    </form>
</section>

<script src='https://use.fontawesome.com/releases/v5.0.13/js/all.js'></script>
<script>
    const msgerForm = document.querySelector(".msger-inputarea");
    const msgerInput = document.querySelector(".msger-input");
    const msgerChat = document.querySelector(".msger-chat");

    const BOT_IMG = "/static/chatbot.png";
    const PERSON_IMG = "/static/user.png";
    const BOT_NAME = "ChatBot";
    const PERSON_NAME = "You";

    msgerForm.addEventListener("submit", event => {
      event.preventDefault();

      const msgText = msgerInput.value;
      if (!msgText) return;

      appendMessage(PERSON_NAME, PERSON_IMG, "right", msgText);
      msgerInput.value = "";
      botResponse(msgText);
    });

    function appendMessage(name, img, side, text) {
      const msgHTML = `
        <div class="msg ${side}-msg">
          <div class="msg-img" style="background-image: url(${img})"></div>
          <div class="msg-bubble">
            <div class="msg-info">
              <div class="msg-info-name">${name}</div>
              <div class="msg-info-time">${formatDate(new Date())}</div>
            </div>
            <div class="msg-text">${text}</div>
          </div>
        </div>
      `;

      msgerChat.insertAdjacentHTML("beforeend", msgHTML);
      msgerChat.scrollTop += 500;
    }



    function formatDate(date) {
      const h = "0" + date.getHours();
      const m = "0" + date.getMinutes();
      return `${h.slice(-2)}:${m.slice(-2)}`;
    }
    // Function to handle the pop-up
function openPopup() {
  // Code to open the pop-up dialog
  // You can use libraries like Bootstrap or jQuery UI for this

  // Create the popup HTML
  const popupHTML = `
    <div class="popup">
      <div class="popup-content">
        <div class="popup-message">Do you want to fill out the Thought Diary?</div>
        <div class="popup-buttons">
          <button class="popup-button" onclick="handlePopupResponse('yes')">Yes</button>
          <button class="popup-button" onclick="handlePopupResponse('no')">No</button>
        </div>
      </div>
    </div>
  `;

  // Append the popup HTML to the chat window
  const chatWindow = document.querySelector(".msger-chat");
  chatWindow.insertAdjacentHTML("beforeend", popupHTML);
}

// Function to handle the user's response to the pop-up
function handlePopupResponse(response) {
  // Code to handle the response and send it back to the server
  // You can use AJAX to send the response to a Flask route for further processing

  // Example code:
  // Send the response to the server
  const formData = new FormData();
  formData.append("popup_response", response);

  fetch("/handle_popup_response", {
    method: "POST",
    body: formData
  })
    .then(response => response.json())
    .then(data => {
      // Handle the server response if needed
      // For example, if the server confirms the response, you can proceed to the Thought Diary page
      if (data.popup_confirmed) {
        window.location.href = "/thought_diary.html";
      }
    });

  // Remove the popup from the chat window
  const popup = document.querySelector(".popup");
  popup.remove();
}

// Function to check if the bot response triggers the popup
function checkTriggerPopup(botResponse) {
  const triggerWords = ["sad"]; // Add more trigger words as needed

  for (const word of triggerWords) {
    if (botResponse.toLowerCase().includes(word)) {
      openPopup();
      break;
    }
  }
}

function botResponse(rawText) {
  // Send the message to the server
  const formData = new FormData();
  formData.append("message", rawText);

  fetch("/chat", {
    method: "POST",
    body: formData
  })
    .then(response => response.json())
    .then(data => {
      const botResponse = data.response;
      appendMessage(BOT_NAME, BOT_IMG, "left", botResponse);

      // Check if the bot response triggers the popup
      checkTriggerPopup(botResponse);
    });
}







</script>
</body>

</html>
