<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>MindCare</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{{ url_for('static', filename='styles/style.css') }}" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
<section class="msger">
    <header class="msger-header">
        <div class="msger-header-title">
            <i class="fas fa-bug"></i> MindCare Chatbot <i class="fas fa-bug"></i>
        </div>
    </header>

    <main class="msger-chat">
        {% for message in messages %}
        {% if message.side == "left" %}
        <div class="msg left-msg">
            {% else %}
            <div class="msg right-msg">
                {% endif %}
                <div class="msg-img" style="background-image: url({{ message.img }})"></div>
                <div class="msg-bubble">
                    <div class="msg-info">
                        <div class="msg-info-name">{{ message.name }}</div>
                        <div class="msg-info-time">{{ message.time }}</div>
                    </div>
                    <div class="msg-text">{{ message.text }}</div>
                </div>
            </div>
            {% endfor %}
    </main>

    {% if confirmation_message %}
    <script>
                function openPopup() {
                    const popup = document.getElementById("popup");
                    popup.style.display = "block";
                }

                function handlePopupResponse(response) {
                    const popupForm = document.getElementById("popup-form");
                    const popupResponseInput = document.getElementById("popup-response");

                    popupResponseInput.value = response;
                    popupForm.submit();
                }







    </script>

    <div id="popup" class="popup">
        <div class="popup-content">
            <div class="popup-message">{{ confirmation_message }}</div>
            <div class="popup-buttons">
                <form id="popup-form" action="/handle_popup_response" method="POST">
                    <input type="hidden" id="popup-response" name="popup_response">
                    <button class="popup-button" onclick="handlePopupResponse('yes')">Yes</button>
                    <button class="popup-button" onclick="handlePopupResponse('no')">No</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <form id="message-form" class="msger-inputarea" method="POST">
        <input id="user-input" class="msger-input" name="message" placeholder="Enter your message..." type="text">
        <button class="msger-send-btn" type="submit">Send</button>
    </form>
</section>

<script src='https://use.fontawesome.com/releases/v5.0.13/js/all.js'></script>
<script>
        const chatWindow = document.getElementById('chat-window');
        const messageForm = document.getElementById('message-form');
        const userInput = document.getElementById('user-input');
        const messages = document.getElementById('messages');
        const popup = document.getElementById('popup');
        const popupYes = document.getElementById('popup-yes');
        const popupNo = document.getElementById('popup-no');

        popupYes.addEventListener('click', handlePopupResponse);
        popupNo.addEventListener('click', handlePopupResponse);

        messageForm.addEventListener('submit', event => {
            event.preventDefault();
            const userMessage = userInput.value;
            appendMessage('You', userMessage);
            userInput.value = '';
            botResponse(userMessage);
        });

        function appendMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            messages.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function botResponse(message) {
            // Send the message to the server and receive the bot response
            // You can make an AJAX request or use WebSocket for real-time communication
            const botResponse = getBotResponse(message);

            // Check if the bot response triggers the popup
            const triggerWords = ['sad']; // Add more trigger words as needed
            const triggerWordFound = checkTrigger(botResponse, triggerWords);

            // Display the bot response
            appendMessage('Bot', botResponse);

            // If the trigger word is found, show the popup
            if (triggerWordFound) {
                openPopup();
            }
        }

        function checkTrigger(message, triggerWords) {
            for (const word of triggerWords) {
                if (message.toLowerCase().includes(word)) {
                    return true;
                }
            }
            return false;
        }

        function openPopup() {
            popup.style.display = 'block';
        }

        function closePopup() {
            popup.style.display = 'none';
        }

        function handlePopupResponse(response) {
            const popupResponseInput = document.getElementById("popup-response");
            popupResponseInput.value = response;
            document.getElementById("popup-form").submit();
        }


        // Simulated function to get the bot response
        function getBotResponse(message) {
            // Replace with your own implementation to get the bot response from the server
            // This is just a placeholder
            const responses = {
                'hello': 'Hello! How can I assist you?',
                'how are you?': 'I am a bot. I do not have feelings.',
                'thank you': 'You\'re welcome!'
            };
            return responses[message.toLowerCase()] || 'Sorry, I didn\'t understand that.';
        }



</script>
</body>

</html>
